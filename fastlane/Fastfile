# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# require 'net/smtp'	

# è¿œç¨‹gitå¼•ç”¨
import_from_git(
	url: 'https://github.com/Maling1255/MGActionLanes.git', 
	branch: 'main', 
	path: 'fastlane/ios_fastfile.rb'
	)

# å®šä¹‰fastlaneç‰ˆæœ¬å·
fastlane_version "2.171.0" 

# å®šä¹‰æ‰“åŒ…å¹³å°
default_platform :ios

# æ„å»º build å·
def updateProjectBuildNumber
	currentTime = Time.new.strftime("%Y%m%d%H%M")

	# è·å–å·²ç»æ„å»ºçš„ç‰ˆæœ¬å·
	build = get_build_number()
	if build.include?"#{currentTime[0...8]}"
		# => ä¸ºå½“å¤©ç‰ˆæœ¬ è®¡ç®—è¿­ä»£ç‰ˆæœ¬å·
		lastStr = build[build.length-2..build.length-1]
		lastNum = lastStr.to_i
		lastNum = lastNum + 1
		lastStr = lastNum.to_s
		  if lastNum < 10
		   lastStr = lastStr.insert(0,"0")
		  end
		build = "#{currentTime}.#{lastStr}"
	else
		# => éå½“å¤©ç‰ˆæœ¬ build å·é‡ç½®
		build = "#{currentTime}.01"
	end
	puts("ğŸ‘‰ *************| æ›´æ–°build #{build} |*************")
	# => æ›´æ”¹é¡¹ç›® build å·
	increment_build_number(build_number: "#{build}")
end



# è·å–ç¯å¢ƒå˜é‡çš„å€¼, ENVåœ¨å½“å‰ç›®å½•ç”¨éšè—æ–‡ä»¶è¡¨ç¤º, é˜²æ­¢è¢«éšä¾¿ä¿®æ”¹
scheme = ENV['SCHEME_NAME']

# ä»»åŠ¡è„šæœ¬
platform :ios do


	desc "æ‰“åŒ…ipaåŒ…ï¼Œä»¥åŠä¸Šä¼ è’²å…¬è‹±å‘é€é‚®ä»¶ä¿¡æ¯"
	lane :development_build do|options|
	branch = options[:branch]
	
	puts("ğŸ‘‰ ************* branchåˆ†æ”¯ #{branch} *************")

	puts "ğŸ‘‰ å‡†å¤‡å»ºç«‹æ–°çš„buildç‰ˆæœ¬å·"
	
	#æ›´æ”¹é¡¹ç›®buildå·
	updateProjectBuildNumber 
	
	puts "ğŸ‘‰ å¼€å§‹æ‰“åŒ…"
	# å¼€å§‹æ‰“åŒ…
	gym(
		workspace: "#{scheme}.xcworkspace",
		scheme: scheme,
		
		# æ˜¯å¦æ¸…ç©ºä»¥å‰çš„ç¼–è¯‘ä¿¡æ¯ trueï¼šæ˜¯
		clean: true,
		# æŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼ŒRelease æˆ–è€… Debug
		configuration: ENV['GYM_CONFIGURATION'],
		# æŒ‡å®šæ‰“åŒ…æ‰€ä½¿ç”¨çš„è¾“å‡ºæ–¹å¼ï¼Œç›®å‰æ”¯æŒapp-store, package, ad-hoc, enterprise, development
		export_method: ENV['GYM_EXPORT_METHOD'],
		#è¾“å‡ºçš„ipaåç§°
		output_name: "#{scheme}_#{get_build_number()}",
		# æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹
		output_directory:"./fastlane/build",
	)
	

	# build_app(workspace: "SchoolBased.xcworkspace", scheme: "SchoolBased", export_method: "development", output_directory: "./fastlane/package", configuration: "Debug")
	# build_app(workspace: "SchoolBased.xcworkspace", scheme: "SchoolBased", export_method: "development", output_directory: "./fastlane/package", configuration: "Debug")
	# build_app(workspace: "SchoolBased.xcworkspace", scheme: "SchoolBased", export_method: "ad-hoc", output_directory: "./fastlane/package", configuration: "Release_Adhoc")
	# build_app(workspace: "SchoolBased.xcworkspace", scheme: "SchoolBased", export_method: "ad-hoc", output_directory: "./fastlane/package", configuration: "Release_Adhoc")


	puts "ğŸ‘‰ å¼€å§‹ä¸Šä¼ è’²å…¬è‹±"

	# å¼€å§‹ä¸Šä¼ è’²å…¬è‹±
	pgyer(
		api_key: ENV['PGY_API_KEY'],
		user_key: ENV['PGY_USER_KEY'],
		update_description: ENV['PGY_UPDATE_DESCRIPTION'], 
      	password: ENV['PGY_INSTALL_PASSWORD'], 
      	install_type: ENV['PGY_INSTALL_TYPE'],
		)
	puts "ğŸ‘‰ ä¸Šä¼ è’²å…¬è‹±å®Œæˆ"





	# -------------------------- å‘é€é‚®ä»¶ ---------------------------
	puts "ğŸ‘‰å¼€å§‹å‘é€é‚®ä»¶"
	# Action.sh "pwd"
	# Action.sh "phthon ios_send_email.py"

	# æ‹¼æ¥é‚®ä»¶æ˜¾ç¤ºçš„å†…å®¹
	
	# äºŒç»´ç 
	appQRCodeURL = "http://www.pgyer.com/app/qrcode/NrfR?sign=TE9DIWHs1jnM2mcAaYWPhr59YiCIm%252BOvjmlT5lmD1u7%252Bf6AWmJuo4vkGdC75ulYs"
	downloadUrl = "http://www.pgyer.com/NrfR"
	installPassword = ENV['PGY_INSTALL_PASSWORD']

    environsString = '<h3>æœ¬æ¬¡æ‰“åŒ…ç›¸å…³ä¿¡æ¯</h3><p>'
    environsString += "ä¿®æ”¹äº†2ä¸ªbug,ä¼˜åŒ–äº†3ä¸ªé¡µé¢ï¼Œ é‡æ„äº†ç™»å½•é¡µé¢"
    environsString += '<p><img src="' + appQRCodeURL + '" style="width:150px;height:150px"></p>'
    # environsString += '<p>ipa åŒ…ä¸‹è½½åœ°å€ : ' + 'wudizhi' + '<p>'
    environsString += '<p>è’²å…¬è‹±ç½‘ç«™åœ¨çº¿å®‰è£… : ' + downloadUrl + '   å¯†ç  : ' + installPassword + '<p>'
    # environsString += '<li><a target="_blank" href="itms-services://?action=download-manifest&url=https://ssl.pgyer.com/app/plist/' + str(appKey) + '">ç‚¹æˆ‘ç›´æ¥å®‰è£…</a></li>'
    message_body = environsString

	mg_send_email(
               stmp_server: "smtp.qq.com",
               user_name:"951684507@qq.com",
               password:"ubbtqklyrscdbdhc",
               # æ¥æ”¶è€…é‚®ç®±
               recipients: ['3178769613@qq.com', 'malgee@163.com', '1271969681@qq.com'],
               subject:"iOSç«¯æµ‹è¯•æ‰“åŒ…å®Œæˆ,å‡†å¤‡æµ‹è¯•",
               message_body:message_body,
               )



	end

	error do |lane, exception|
    	UI.message(exception.message)
    	mg_send_email(
               stmp_server: "smtp.qq.com",
               user_name:"951684507@qq.com",
               password:"ubbtqklyrscdbdhc",
               recipients: ['951684507@qq.com'],
               subject:"æ‰“åŒ…å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥åŸå› ",
               message_body:"#{exception.message}",
               )
   end
end

